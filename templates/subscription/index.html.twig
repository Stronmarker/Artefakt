{% extends 'base.logged.html.twig' %}

{% block title %}Abonnements{% endblock %}

{% block body %}
<style> 
    .centered-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
    }
    .card-shadow {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 6px 20px rgba(0, 0, 0, 0.1), 0 0 15px white;
        border-radius: 20px;
        border: 7px solid #000;
        width: 100%;
        max-width: 600px;
        padding: 20px;
    }
    .centered-title {
        margin-bottom: 20px;
    }
    .card-title {
        margin-bottom: 10px;
    }
</style>

<div class="container centered-container mb-4">
    <h1 class="text-center text-white centered-title ft_orbitron">Notre Offre Premium</h1>
    <div class="card card-shadow">
        <div class="card-body">
            <h5 class="card-title text-success fw-bold text-center ft_orbitron">Abonnement Premium</h5>
            <h6 class="card-subtitle mb-2 text-dark fw-bold text-center ft_audiowide">€20/mois</h6>
            <ul class="list-unstyled">
                <li class="ft_audiowide text-center">Projets illimités</li>
                <li class="ft_audiowide text-center">Outils illimités</li>
                <li class="ft_audiowide text-center">Assistance par e-mail</li>
                <li class="ft_audiowide text-center">Accès au centre d'aide</li>
            </ul>

            {% if not isSubscribed %}
                <form id="subscription-form">
                    <input type="email" id="email" placeholder="Email" required class="form-control mb-3" />
                    <div id="card-element" class="form-control mb-3"></div>
                    <button type="submit" class="btn btn-success mt-3 fw-bold d-block mx-auto ft_wallpoet">Souscrire</button>
                </form>
            {% else %}
                <p class="text-center text-success fw-bold ft_orbitron">Vous êtes déjà abonné. Merci !</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{% if not isSubscribed %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script> 
<script src="https://js.stripe.com/v3/"></script> 

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stripe = Stripe('{{ public_key }}');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        document.getElementById('subscription-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const { error, paymentMethod } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: { email: email }
            });

            if (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: error.message,
                });
            } else {
                fetch('{{ path("app_subscribe") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        email: email,
                        payment_method: paymentMethod.id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Félicitations !',
                            text: 'Vous avez bien souscrit à l\'offre premium.',
                            showConfirmButton: false,
                            timer: 2000
                        }).then(function() {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'Déjà abonné',
                            text: data.message || 'Vous êtes déjà abonné',
                        });
                    }
                })
                .catch(error => {
                    console.error(error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Une erreur s\'est produite. Veuillez réessayer.',
                    });
                });
            }
        });
    });
</script>
{% endif %}
{% endblock %}
